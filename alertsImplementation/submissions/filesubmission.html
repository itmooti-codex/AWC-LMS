<!-- External Libs for mentions -->
<script src="https://cdn.jsdelivr.net/npm/tributejs@5.1.3/dist/tribute.min.js"></script>

<style>
  textarea {
    margin: 0 !important;
    height: unset !important;
    -webkit-box-shadow: none !important;
    box-shadow: none !important;
    border: 1px solid #d3d7e2 !important;
    outline: none !important;
    border-radius: 4px !important;
    padding: 12px 12px !important;
    width: 100% !important;
    box-sizing: border-box !important;
    background-color: white !important;

    &:hover {
      border: 1px solid #007b8e !important;
    }

    &:active {
      border: 1px solid #007b8e !important;
    }

    &:focus {
      border: 1px solid #007b8e !important;
    }
  }
</style>
<div class="p-3 mb-4 bg-[#ffc7cd] rounded justify-start items-center gap-4 hidden" id="upload_failed_msg">
  <div data-svg-wrapper class="relative">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path
        d="M20.6981 7.60962L15.3135 2.225C15.242 2.15359 15.1571 2.09696 15.0637 2.05836C14.9704 2.01975 14.8703 1.99992 14.7692 2H5.53846C5.13044 2 4.73912 2.16209 4.4506 2.45061C4.16209 2.73912 4 3.13044 4 3.53846V20.4615C4 20.8696 4.16209 21.2609 4.4506 21.5494C4.73912 21.8379 5.13044 22 5.53846 22H19.3846C19.7926 22 20.184 21.8379 20.4725 21.5494C20.761 21.2609 20.9231 20.8696 20.9231 20.4615V8.15385C20.9232 8.0528 20.9033 7.95273 20.8647 7.85935C20.8261 7.76597 20.7695 7.68111 20.6981 7.60962ZM15.5385 16.6154H9.38462C9.1806 16.6154 8.98495 16.5343 8.84069 16.3901C8.69643 16.2458 8.61538 16.0502 8.61538 15.8462C8.61538 15.6421 8.69643 15.4465 8.84069 15.3022C8.98495 15.158 9.1806 15.0769 9.38462 15.0769H15.5385C15.7425 15.0769 15.9381 15.158 16.0824 15.3022C16.2266 15.4465 16.3077 15.6421 16.3077 15.8462C16.3077 16.0502 16.2266 16.2458 16.0824 16.3901C15.9381 16.5343 15.7425 16.6154 15.5385 16.6154ZM15.5385 13.5385H9.38462C9.1806 13.5385 8.98495 13.4574 8.84069 13.3132C8.69643 13.1689 8.61538 12.9732 8.61538 12.7692C8.61538 12.5652 8.69643 12.3696 8.84069 12.2253C8.98495 12.081 9.1806 12 9.38462 12H15.5385C15.7425 12 15.9381 12.081 16.0824 12.2253C16.2266 12.3696 16.3077 12.5652 16.3077 12.7692C16.3077 12.9732 16.2266 13.1689 16.0824 13.3132C15.9381 13.4574 15.7425 13.5385 15.5385 13.5385ZM14.7692 8.15385V3.92308L19 8.15385H14.7692Z"
        fill="#C52637" />
    </svg>
  </div>
  <div class="grow shrink basis-0 text-[#c42637] text-sm font-semibold font-['Open Sans'] leading-[18px]"
    id="error-fileName">
    Assignment.docx
  </div>
  <div class="grow shrink basis-0 text-right text-[#c42637] text-sm font-normal font-['Open Sans'] leading-tight">
    Upload failed !
  </div>
</div>

<div
  class="w-full p-10 bg-white cursor-pointer rounded border border-[#bbbcbb] border-dashed flex-col justify-start items-center gap-2 inline-flex overflow-hidden fileUploadMainWrapper"
  @click="
                 document.querySelector('#upload_failed_msg').classList.add('hidden');
                 document.querySelector('#upload_failed_msg').classList.remove('flex');
                 document.querySelector('#fileInput').click();">
  <div data-svg-wrapper class="relative">
    <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path
        d="M36.6655 24.167V35.2777C36.6655 35.6461 36.5192 35.9993 36.2587 36.2598C35.9983 36.5203 35.645 36.6666 35.2767 36.6666H4.7221C4.35375 36.6666 4.00049 36.5203 3.74004 36.2598C3.47958 35.9993 3.33325 35.6461 3.33325 35.2777V24.167C3.33325 23.7987 3.47958 23.4454 3.74004 23.1849C4.00049 22.9245 4.35375 22.7782 4.7221 22.7782C5.09044 22.7782 5.4437 22.9245 5.70416 23.1849C5.96461 23.4454 6.11094 23.7987 6.11094 24.167V33.8889H33.8878V24.167C33.8878 23.7987 34.0341 23.4454 34.2946 23.1849C34.555 22.9245 34.9083 22.7782 35.2767 22.7782C35.645 22.7782 35.9983 22.9245 36.2587 23.1849C36.5192 23.4454 36.6655 23.7987 36.6655 24.167ZM13.0552 13.0562H18.6105V24.167C18.6105 24.5353 18.7569 24.8886 19.0173 25.1491C19.2778 25.4095 19.631 25.5558 19.9994 25.5558C20.3677 25.5558 20.721 25.4095 20.9814 25.1491C21.2419 24.8886 21.3882 24.5353 21.3882 24.167V13.0562H26.9436C27.2184 13.0565 27.4872 12.9751 27.7158 12.8225C27.9444 12.6699 28.1225 12.453 28.2277 12.199C28.333 11.9451 28.3605 11.6657 28.3068 11.3962C28.2531 11.1266 28.1207 10.879 27.9262 10.6848L20.982 3.74058C20.853 3.61145 20.6998 3.50901 20.5312 3.43912C20.3626 3.36923 20.1819 3.33325 19.9994 3.33325C19.8169 3.33325 19.6361 3.36923 19.4675 3.43912C19.2989 3.50901 19.1458 3.61145 19.0168 3.74058L12.0725 10.6848C11.8781 10.879 11.7456 11.1266 11.692 11.3962C11.6383 11.6657 11.6658 11.9451 11.771 12.199C11.8762 12.453 12.0544 12.6699 12.283 12.8225C12.5116 12.9751 12.7803 13.0565 13.0552 13.0562Z"
        fill="#007C8F" />
    </svg>
  </div>
  <div class="text-[#586a80] text-sm font-normal font-['Open Sans'] leading-tight">
    Drag and drop files here
  </div>
  <div class="text-[#586a80] text-sm font-normal font-['Open Sans'] leading-tight">
    Or
  </div>
  <div class="px-3 py-2 bg-[#007b8e] rounded justify-center items-center gap-2 inline-flex">
    <div class="text-white text-xs font-semibold font-['Open Sans'] leading-3">
      Browse files
    </div>
  </div>
</div>

<!-- File Preview Box -->
<div id="filePreview" class="h-12 p-3 bg-[#c6e5e5] rounded justify-start items-center gap-2 inline-flex"
  style="display: none">
  <div data-svg-wrapper class="relative">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path
        d="M20.6981 7.60962L15.3135 2.225C15.242 2.15359 15.1571 2.09696 15.0637 2.05836C14.9704 2.01975 14.8703 1.99992 14.7692 2H5.53846C5.13044 2 4.73912 2.16209 4.4506 2.45061C4.16209 2.73912 4 3.13044 4 3.53846V20.4615C4 20.8696 4.16209 21.2609 4.4506 21.5494C4.73912 21.8379 5.13044 22 5.53846 22H19.3846C19.7926 22 20.184 21.8379 20.4725 21.5494C20.761 21.2609 20.9231 20.8696 20.9231 20.4615V8.15385C20.9232 8.0528 20.9033 7.95273 20.8647 7.85935C20.8261 7.76597 20.7695 7.68111 20.6981 7.60962ZM15.5385 16.6154H9.38462C9.1806 16.6154 8.98495 16.5343 8.84069 16.3901C8.69643 16.2458 8.61538 16.0502 8.61538 15.8462C8.61538 15.6421 8.69643 15.4465 8.84069 15.3022C8.98495 15.158 9.1806 15.0769 9.38462 15.0769H15.5385C15.7425 15.0769 15.9381 15.158 16.0824 15.3022C16.2266 15.4465 16.3077 15.6421 16.3077 15.8462C16.3077 16.0502 16.2266 16.2458 16.0824 16.3901C15.9381 16.5343 15.7425 16.6154 15.5385 16.6154ZM15.5385 13.5385H9.38462C9.1806 13.5385 8.98495 13.4574 8.84069 13.3132C8.69643 13.1689 8.61538 12.9732 8.61538 12.7692C8.61538 12.5652 8.69643 12.3696 8.84069 12.2253C8.98495 12.081 9.1806 12 9.38462 12H15.5385C15.7425 12 15.9381 12.081 16.0824 12.2253C16.2266 12.3696 16.3077 12.5652 16.3077 12.7692C16.3077 12.9732 16.2266 13.1689 16.0824 13.3132C15.9381 13.4574 15.7425 13.5385 15.5385 13.5385ZM14.7692 8.15385V3.92308L19 8.15385H14.7692Z"
        fill="#007C8F" />
    </svg>
  </div>
  <div id="fileName" class="grow shrink basis-0 text-[#007b8e] text-sm font-semibold font-['Open Sans'] leading-[18px]">
    File Name
  </div>
  <div data-svg-wrapper class="dltFileWrap" style="cursor: pointer">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path
        d="M20.6923 5.07692H16.8462V4.30769C16.8462 3.69565 16.603 3.10868 16.1702 2.67591C15.7375 2.24313 15.1505 2 14.5385 2H9.92308C9.31104 2 8.72407 2.24313 8.29129 2.67591C7.85852 3.10868 7.61538 3.69565 7.61538 4.30769V5.07692H3.76923C3.56522 5.07692 3.36956 5.15797 3.2253 5.30223C3.08104 5.44648 3 5.64214 3 5.84615C3 6.05017 3.08104 6.24582 3.2253 6.39008C3.36956 6.53434 3.56522 6.61538 3.76923 6.61538H4.53846V20.4615C4.53846 20.8696 4.70055 21.2609 4.98907 21.5494C5.27758 21.8379 5.6689 22 6.07692 22H18.3846C18.7926 22 19.184 21.8379 19.4725 21.5494C19.761 21.2609 19.9231 20.8696 19.9231 20.4615V6.61538H20.6923C20.8963 6.61538 21.092 6.53434 21.2362 6.39008C21.3805 6.24582 21.4615 6.05017 21.4615 5.84615C21.4615 5.64214 21.3805 5.44648 21.2362 5.30223C21.092 5.15797 20.8963 5.07692 20.6923 5.07692ZM10.6923 16.6154C10.6923 16.8194 10.6113 17.0151 10.467 17.1593C10.3227 17.3036 10.1271 17.3846 9.92308 17.3846C9.71906 17.3846 9.52341 17.3036 9.37915 17.1593C9.23489 17.0151 9.15385 16.8194 9.15385 16.6154V10.4615C9.15385 10.2575 9.23489 10.0619 9.37915 9.91761C9.52341 9.77335 9.71906 9.69231 9.92308 9.69231C10.1271 9.69231 10.3227 9.77335 10.467 9.91761C10.6113 10.0619 10.6923 10.2575 10.6923 10.4615V16.6154ZM15.3077 16.6154C15.3077 16.8194 15.2266 17.0151 15.0824 17.1593C14.9381 17.3036 14.7425 17.3846 14.5385 17.3846C14.3344 17.3846 14.1388 17.3036 13.9945 17.1593C13.8503 17.0151 13.7692 16.8194 13.7692 16.6154V10.4615C13.7692 10.2575 13.8503 10.0619 13.9945 9.91761C14.1388 9.77335 14.3344 9.69231 14.5385 9.69231C14.7425 9.69231 14.9381 9.77335 15.0824 9.91761C15.2266 10.0619 15.3077 10.2575 15.3077 10.4615V16.6154ZM15.3077 5.07692H9.15385V4.30769C9.15385 4.10368 9.23489 3.90802 9.37915 3.76376C9.52341 3.61951 9.71906 3.53846 9.92308 3.53846H14.5385C14.7425 3.53846 14.9381 3.61951 15.0824 3.76376C15.2266 3.90802 15.3077 4.10368 15.3077 4.30769V5.07692Z"
        fill="#007C8F" />
    </svg>
  </div>
</div>
<div id="progressBarContainer" class="w-full bg-gray-300 h-[2px] rounded-[30px] hidden">
  <div id="uploadProgress" class="h-[2px] bg-[#007C8F]" style="width: 0%"></div>
</div>
<div class="!mt-4">
  <div class="containerForToolbar"></div>
  <div contenteditable="true" placeholder="Write Your Asssignment..."
    class="resize-y mentionable !min-h-[103px] !p-4 !bg-white !rounded-tl-[4px] !rounded-tr-none !rounded-br-[4px] !rounded-bl-[4px] !border !border-[#bbbcbb] !text-[#586a80] !text-base !font-normal !font-['Open_Sans'] !leading-normal !resize-none !w-full transition"
    id="noteForSubmission"></div>
</div>
<!-- <textarea placeholder="Write Your Asssignment..." class="mentionable !h-[103px] !mt-4 !p-4 !bg-white !rounded !border !border-[#bbbcbb] !text-[#586a80] !text-base !font-normal !font-['Open_Sans'] !leading-normal !resize-none !w-full transition" id="noteForSubmission">
    </textarea> -->

<input type="file" name="uploadFileQueryBuilder" id="fileInput"
  class="w-full hidden text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none" />
<div id="uploadButton"
  class="mt-4 w-fit ml-auto bg-[#007C8F] cursor-pointer text-white px-4 py-2 rounded flex items-center gap-2 transition">
  <div>Submit</div>
  <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path
      d="M10.4282 5.99409C10.4285 6.12138 10.3948 6.24645 10.3306 6.35635C10.2664 6.46625 10.174 6.557 10.0629 6.61922L2.56502 10.9062C2.45742 10.9672 2.33595 10.9995 2.21227 11C2.09832 10.9994 1.98616 10.9715 1.88517 10.9187C1.78417 10.8659 1.69727 10.7898 1.63172 10.6965C1.56617 10.6033 1.52386 10.4958 1.50834 10.3829C1.49282 10.27 1.50453 10.155 1.54249 10.0476L2.74809 6.47767C2.75987 6.44277 2.78216 6.41236 2.8119 6.39062C2.84163 6.36888 2.87736 6.35686 2.9142 6.35622H6.14162C6.19059 6.35633 6.23906 6.34636 6.28402 6.32695C6.32898 6.30754 6.36946 6.27909 6.40296 6.24337C6.43646 6.20765 6.46226 6.16543 6.47875 6.11932C6.49525 6.07321 6.50208 6.0242 6.49884 5.97534C6.49074 5.88348 6.44824 5.79808 6.37985 5.73623C6.31145 5.67438 6.22222 5.64065 6.13002 5.64179H2.91509C2.87772 5.64179 2.84129 5.63008 2.81094 5.60829C2.78058 5.5865 2.75782 5.55574 2.74586 5.52034L1.54026 1.95088C1.49228 1.81406 1.48705 1.66588 1.52529 1.52603C1.56352 1.38617 1.6434 1.26126 1.75432 1.16789C1.86524 1.07451 2.00194 1.01709 2.14626 1.00326C2.29059 0.989426 2.43571 1.01983 2.56234 1.09044L10.0638 5.37209C10.1743 5.43416 10.2662 5.52447 10.3302 5.63377C10.3942 5.74307 10.4281 5.86742 10.4282 5.99409Z"
      fill="white" />
  </svg>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const dropTarget = document.querySelector(".fileUploadMainWrapper");
    const fileInput = document.querySelector("#fileInput");
    const filePreview = document.getElementById("filePreview");
    const fileNameText = document.getElementById("fileName");
    const fileUploadMainWrapper = document.querySelector(
      ".fileUploadMainWrapper"
    );
    const deleteFile = document.querySelector(".dltFileWrap");
    fileInput.addEventListener("change", function () {
      if (fileInput.files.length > 0) {
        fileNameText.textContent = fileInput.files[0].name;
        fileUploadMainWrapper.style.display = "none";
        filePreview.style.display = "flex";
      }
    });
    deleteFile.addEventListener("click", function () {
      fileInput.value = "";
      filePreview.style.display = "none";
      fileUploadMainWrapper.style.display = "flex";
    });

    ["dragenter", "dragover", "dragleave", "drop"].forEach((event) => {
      dropTarget.addEventListener(event, (e) => {
        e.preventDefault();
        e.stopPropagation();
      });
    });

    dropTarget.addEventListener("drop", function (e) {
      const droppedFiles = e.dataTransfer.files;
      if (droppedFiles.length === 0) return;

      const dt = new DataTransfer();
      for (let i = 0; i < droppedFiles.length; i++) {
        dt.items.add(droppedFiles[i]);
      }

      fileInput.files = dt.files;

      // Important: Trigger change event manually
      const event = new Event("change", { bubbles: true });
      fileInput.dispatchEvent(event);
    });

    // Initialize mentions editor (Tribute)
    initMentionsEditor();
  });
</script>
<script>
  const awsParam = "ee037b98f52d6f86c4d3a4cc4522de1e";
  const awsParamUrl = "https://courses.writerscentre.com.au/s/aws";
  const GRAPHQL_ENDPOINTssss = "https://awc.vitalstats.app/api/v1/graphql";
  const apiKeyKey = "mMzQezxyIwbtSc85rFPs3";

  function getStudentEnrollmentID() {
    let urls = window.location.href;
    let matchs = urls.match(/[\?&]eid=(\d+)/);
    return matchs ? parseInt(matchs[1]) : null;
  }
  async function createSubmission(file, assessmentId, studentId, allMentions) {
    const studentEnrollmentID = getStudentEnrollmentID();
    const submissionNote = document.querySelector("#noteForSubmission");
    let formattedContent = submissionNote.innerHTML.trim();
    let formattedContentss = submissionNote.innerHTML;
    try {
      const fileInput = document.querySelector("#fileInput");
      let fileData = "";
      const file = fileInput.files[0];
      if (file) {
        const fileFields = [{ fieldName: "attachment", file: file }];
        const toSubmitFields = {};
        try {
          await processFileFields(
            toSubmitFields,
            fileFields,
            awsParam,
            awsParamUrl
          );
          fileData = toSubmitFields.attachment || "";
        } catch (err) {
          fileData = "";
        }
      }

      let fileCategorySubmission = "File";
      let fileNameSubmission = "file.txt";
      if (typeof fileData === "string") {
        try {
          fileData = JSON.parse(fileData);
          fileNameSubmission = fileData.name;
          if (fileData.type.startsWith("image/")) {
            fileCategorySubmission = "Image";
          } else if (fileData.type.startsWith("video/")) {
            fileCategorySubmission = "Video";
          } else if (fileData.type.startsWith("audio/")) {
            fileCategorySubmission = "Audio";
          }
        } catch (err) { }
      }
      const payload = {
        file_upload: fileData,
        file_upload_name: fileNameSubmission,
        file_upload_type: fileCategorySubmission,
        assessment_id: assessmentId,
        student_id: studentEnrollmentID,
        submission_note: formattedContentss,
        Student: {
          student_id: studentId,
        },
        Submission_Mentions: allMentions,
      };

      return fetch(GRAPHQL_ENDPOINTssss, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Api-Key": apiKeyKey,
        },
        body: JSON.stringify({
          query: `
    mutation createSubmission($payload: SubmissionCreateInput = null) {
      createSubmission(payload: $payload) {
        id
        unique_id
        file_upload
        file_upload_name
        file_upload_type
        assessment_id
        student_id
        submission_note
        Student { student_id }
        Submission_Mentions { unique_id has__new__notification }
      }
    }
    `,
          variables: { payload },
        }),
      })
        .then((res) => res.json())
        .then((data) => {
          if (data.errors) {
            throw new Error("GraphQL error: " + JSON.stringify(data.errors));
          }
          document.querySelector(".dltFileWrap").click();
          return data.data.createSubmission;
        });
    } catch (error) {
      return null;
    }
  }

  // Mentions: build list and attach Tribute to the editor
  async function resolveClassIdFromEid() {
    try {
      const url = new URL(window.location.href);
      // Prefer classIdFromUrl when present (teacher/admin views)
      const classIdParam = url.searchParams.get("classIdFromUrl");
      if (classIdParam && Number(classIdParam)) return Number(classIdParam);
      const m = window.location.href.match(/[?&]eid=(\d+)/);
      const eid = m ? Number(m[1]) : null;
      if (!eid) {
        console.warn(
          "[FileSubmission] No classIdFromUrl or eid in URL; mentions list may be empty"
        );
        return null;
      }
      const q = `query eidToClass($id: AwcEnrolmentID) { calcEnrolments(query: [{ where: { id: $id } }]) { Class_ID: field(arg: ["class_id"]) } }`;
      const rs = await fetch(GRAPHQL_ENDPOINTssss, {
        method: "POST",
        headers: { "Content-Type": "application/json", "Api-Key": apiKeyKey },
        body: JSON.stringify({ query: q, variables: { id: eid } }),
      }).then((r) => (r.ok ? r.json() : null));
      const clsId =
        Number(rs?.data?.calcEnrolments?.[0]?.Class_ID || 0) || null;
      return clsId;
    } catch (_) {
      return null;
    }
  }

  // async function fetchMentionContacts(classId) {
  //   const q = `query getClassMentions($id: AwcClassID) { getClasses(query: [{ where: { id: $id } }]) { Teacher { id display_name first_name last_name profile_image } Enrolments { Student { id display_name first_name last_name profile_image } } } }`;
  //   const adminQ = `query { getContact(query: [{ where: { email: "courses@writerscentre.com.au" } }]) { id display_name profile_image } }`;
  //   try {
  //     const [cls, adm] = await Promise.all([
  //       fetch(GRAPHQL_ENDPOINTssss, {
  //         method: "POST",
  //         headers: { "Content-Type": "application/json", "Api-Key": apiKeyKey },
  //         body: JSON.stringify({
  //           query: q,
  //           variables: { id: Number(classId) },
  //         }),
  //       }).then((r) => (r.ok ? r.json() : null)),
  //       fetch(GRAPHQL_ENDPOINTssss, {
  //         method: "POST",
  //         headers: { "Content-Type": "application/json", "Api-Key": apiKeyKey },
  //         body: JSON.stringify({ query: adminQ }),
  //       }).then((r) => (r.ok ? r.json() : null)),
  //     ]);
  //     const data = cls?.data?.getClasses?.[0] || {};
  //     const teacher = data?.Teacher ? [data.Teacher] : [];
  //     const students = Array.isArray(data?.Enrolments)
  //       ? data.Enrolments.map((e) => e.Student).filter(Boolean)
  //       : [];
  //     const admin = adm?.data?.getContact ? [adm.data.getContact] : [];
  //     const all = [...teacher, ...students, ...admin].filter(Boolean);
  //     const values = all
  //       .map((c) => ({
  //         key:
  //           c.display_name ||
  //           `${c.first_name || ""} ${c.last_name || ""}`.trim(),
  //         value: c.id,
  //         image: c.profile_image,
  //       }))
  //       .filter((v) => v.key && v.value);
  //     try {
  //       console.log("[FileSubmission] Mention candidates", {
  //         classId,
  //         count: values.length,
  //         sample: values[0],
  //       });
  //     } catch (_) {}
  //     return values;
  //   } catch (e) {
  //     console.error("Failed to fetch mention contacts", e);
  //     return [];
  //   }
  // }

  // async function initMentionsEditor() {
  //   try {
  //     if (typeof Tribute === "undefined") {
  //       console.warn(
  //         "[FileSubmission] Tribute not available, mentions disabled"
  //       );
  //       return;
  //     }
  //     const classId = await resolveClassIdFromEid();
  //     if (!classId) return;
  //     const values = await fetchMentionContacts(classId);
  //     try { window.__fileSubMentionValues = (values || []).slice(); } catch(_) {}
  //     const tribute = new Tribute({
  //       values,
  //       menuItemTemplate: function (item) {
  //         if (!item || !item.original) return "";
  //         const img = item.original.image || "";
  //         return `<div class="cursor-pointer inline-flex items-center gap-x-1"><img src="${img}" style="object-fit:cover;height:20px;width:20px;border-radius:50%"><span>${item.original.key}</span></div>`;
  //       },
  //       selectTemplate: function (item) {
  //         if (!item || !item.original) return "";
  //         const id = item.original.value;
  //         const key = item.original.key;
  //         try { console.log('[FileSubmission] selectTemplate', { id, key }); } catch(_) {}
  //         return `<span class="mention-handle label bg-[#ebf6f6] text-[#007c8a] py-[1px] px-[2px] rounded" data-mention-id="${id}">@${key}</span>`;
  //       },
  //     });
  //     const editor = document.getElementById("noteForSubmission");
  //     if (editor) {
  //       tribute.attach(editor);
  //       // Optional: simple placeholder
  //       if (!editor.textContent.trim()) {
  //         editor.innerHTML =
  //           '<span class="placeholder text-[#586a80] text-sm"><i>Type @ to mentionâ€¦</i></span>';
  //       }
  //       editor.addEventListener("focus", () => {
  //         const ph = editor.querySelector(".placeholder");
  //         if (ph) editor.innerHTML = "";
  //       });
  //       editor.addEventListener('tribute-replaced', (e) => {
  //         try { console.log('[FileSubmission] tribute-replaced', { item: e?.detail?.item, html: editor.innerHTML }); } catch(_) {}
  //       });
  //     }
  //   } catch (e) {
  //     console.error("[FileSubmission] Failed to init mentions", e);
  //   }
  // }
  // function gatherMentionsFromElementt(el) {
  //   const mentionEls = el.querySelectorAll('.mention-handle[data-mention-id]');
  //   const fromSpans = [...mentionEls]
  //     .map((m) => {
  //       const idStr = m.getAttribute('data-mention-id');
  //       if (!idStr) return null;
  //       const idNum = Number(idStr);
  //       return Number.isFinite(idNum) ? { id: idNum, has__new__notification: true } : null;
  //     })
  //     .filter(Boolean);
  //   if (fromSpans.length) return fromSpans;
  //   try {
  //     const text = (el && el.textContent) ? el.textContent : '';
  //     const tokens = [...new Set((text.match(/@([^\s,@]+)/g) || []).map(t => t.replace(/^@/, '')))] || [];
  //     const candidates = Array.isArray(window.__fileSubMentionValues) ? window.__fileSubMentionValues : [];
  //     const mapped = tokens.map(tok => {
  //       const lowerTok = tok.toLowerCase();
  //       const match = candidates.find(c => String(c.key || '').toLowerCase().startsWith(lowerTok));
  //       if (!match) return null;
  //       return { id: Number(match.value), has__new__notification: true };
  //     }).filter(Boolean);
  //     if (mapped.length) {
  //       console.warn('[FileSubmission] Fallback mention mapping used', { tokens, mapped });
  //       return mapped;
  //     }
  //   } catch(_) {}
  //   return [];
  // }

  // Mentions extractor: mirror commentSubmission.html semantics
  function gatherMentionsFromElementt(el) {
    try {
      const html = (el && typeof el.innerHTML === 'string')
        ? el.innerHTML
        : (document.getElementById('noteForSubmission')?.innerHTML || '');
      const matches = Array.from(html.matchAll(/data-mention-id=\"(.*?)\"/g));
      return matches
        .map((m) => ({ unique_id: m[1], has__new__notification: true }))
        .filter((obj) => obj && obj.unique_id);
    } catch (_) {
      return [];
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    const uploadButton = document.querySelector("#uploadButton");
    const progressBar = document.querySelector("#uploadProgress");
    const progressBarContainer = document.querySelector(
      "#progressBarContainer"
    );
    const textarea =
      document.querySelector("#uploadButton").previousElementSibling
        .previousElementSibling;
    const allMentions = gatherMentionsFromElementt(textarea);
    try {
      const idsOnlyInit = allMentions.map((m) => m && m.id).filter(Boolean);
      console.log("[FileSubmission:init] Mentions extracted", {
        allMentions,
        idsOnly: idsOnlyInit,
      });
    } catch (_) { }

    uploadButton.addEventListener("click", async () => {
      const allMentions = gatherMentionsFromElementt(textarea);
      try {
        const idsOnly = allMentions.map((m) => m && m.id).filter(Boolean);
        console.log("[FileSubmission] Mentions extracted", {
          allMentions,
          idsOnly,
        });
      } catch (_) { }

      const file = document.querySelector("#fileInput").files[0];
      //if (!file) {
      // progressBarContainer.style.display = "none";
      // return;
      // }
      status.textContent = "Uploading...";
      progressBarContainer.style.display = "block";
      progressBar.style.width = "0%";

      // Simulate progress animation
      let progress = 0;
      const interval = setInterval(() => {
        if (progress < 90) {
          progress += 10;
          updateProgress(progress);
        } else {
          clearInterval(interval);
        }
      }, 500);

      try {
        textarea.classList.add("opacity-50", "pointer-events-none");
        uploadButton.classList.add("opacity-50", "pointer-events-none");
        const result = await createSubmission(
          file,
          "[Page//Assessment//ID]",
          "[Visitor//Contact ID]",
          allMentions
        );
        clearInterval(interval);
        updateProgress(100);
        if (result) {
          // Fire alerts for new submission
          try {
            (async function createSubmissionAlertsStudent() {
              try {
                const submissionId = Number(result?.id || 0);
                if (!Number.isFinite(submissionId) || submissionId <= 0) return;
                const uniqueId = String(result?.unique_id || "");
                const submission_noteCreated = String(
                  result?.submission_note || ""
                );
                const tmp = document.createElement("div");
                tmp.innerHTML = submission_noteCreated;
                const contentText = (tmp.textContent || "").trim();
                const createdAt = new Date().toISOString();

                // Resolve Class ID via enrolment (eid in URL)
                const urls = window.location.href;
                const m = urls.match(/[?&]eid=(\d+)/);
                const eid = m ? Number(m[1]) : null;
                let classId = null;
                if (eid) {
                  const qClassId = `query eidToClass($id: AwcEnrolmentID) { calcEnrolments(query: [{ where: { id: $id } }]) { Class_ID: field(arg: ["class_id"]) } }`;
                  const res = await fetch(GRAPHQL_ENDPOINTssss, {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                      "Api-Key": apiKeyKey,
                    },
                    body: JSON.stringify({
                      query: qClassId,
                      variables: { id: eid },
                    }),
                  }).then((r) => (r.ok ? r.json() : null));
                  classId =
                    Number(res?.data?.calcEnrolments?.[0]?.Class_ID || 0) ||
                    null;
                }
                if (!classId) return;

                // Class roster (students) + Teacher + Admin
                const qTeacher = `query teacherByClass($id: AwcClassID) { calcClasses(query: [{ where: { id: $id } }]) { Teacher_Contact_ID: field(arg: ["Teacher", "id"]) } }`;
                const qClasses = `query getClassStudents($id: AwcClassID) {
                  getClasses(query: [{ where: { id: $id } }]) {
                    id
                    unique_id
                    class_name
                    Course { unique_id course_name }
                    Teacher { id unique_id }
                    Enrolments { Student { id unique_id } }
                  }
                }`;
                const qEnrol = `query getClassEnrolmentStudents($id: AwcClassID) { calcEnrolments(query: [{ where: { class_id: $id } }]) { Student_ID: field(arg: ["Student","id"]) } }`;
                const [resTeacher, resClasses, resEnrol] = await Promise.all([
                  fetch(GRAPHQL_ENDPOINTssss, {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                      "Api-Key": apiKeyKey,
                    },
                    body: JSON.stringify({
                      query: qTeacher,
                      variables: { id: classId },
                    }),
                  }).then((r) => (r.ok ? r.json() : null)),
                  fetch(GRAPHQL_ENDPOINTssss, {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                      "Api-Key": apiKeyKey,
                    },
                    body: JSON.stringify({
                      query: qClasses,
                      variables: { id: classId },
                    }),
                  }).then((r) => (r.ok ? r.json() : null)),
                  fetch(GRAPHQL_ENDPOINTssss, {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                      "Api-Key": apiKeyKey,
                    },
                    body: JSON.stringify({
                      query: qEnrol,
                      variables: { id: classId },
                    }),
                  }).then((r) => (r.ok ? r.json() : null)),
                ]);
                const norm = (list) =>
                  (Array.isArray(list) ? list : [list])
                    .map((v) => Number(v))
                    .filter((n) => Number.isFinite(n) && n > 0);
                let teacherIds = [];
                const tRaw =
                  resTeacher?.data?.calcClasses?.[0]?.Teacher_Contact_ID;
                if (tRaw != null) teacherIds = norm(tRaw);
                const classes = Array.isArray(resClasses?.data?.getClasses)
                  ? resClasses.data.getClasses
                  : [];
                let classUid, className, courseUid;
                const idsFromClasses = classes.flatMap((c) => {
                  if (!classUid && c?.unique_id) classUid = c.unique_id;
                  if (!className && c?.class_name) className = c.class_name;
                  if (!courseUid && c?.Course?.unique_id)
                    courseUid = c.Course.unique_id;
                  return (Array.isArray(c?.Enrolments) ? c.Enrolments : [])
                    .map((e) => e?.Student?.id)
                    .filter(Boolean);
                });
                // Build a contactId -> unique_id map to resolve mentions
                const idToUidMap = new Map();
                for (const c of classes) {
                  try {
                    if (c?.Teacher?.id != null && c?.Teacher?.unique_id)
                      idToUidMap.set(Number(c.Teacher.id), String(c.Teacher.unique_id));
                  } catch (_) {}
                  const enrols = Array.isArray(c?.Enrolments) ? c.Enrolments : [];
                  for (const e of enrols) {
                    const sid = e?.Student?.id;
                    const suid = e?.Student?.unique_id;
                    if (sid != null && suid) idToUidMap.set(Number(sid), String(suid));
                  }
                }
                const enrolRows = Array.isArray(resEnrol?.data?.calcEnrolments)
                  ? resEnrol.data.calcEnrolments
                  : [];
                const idsFromEnrol = enrolRows.flatMap((row) =>
                  norm(row?.Student_ID)
                );
                const adminIds = [10435];
                const authorId = Number("[Visitor//Contact ID]") || 0;
                const seen = new Set();
                let audience = norm([
                  ...idsFromClasses,
                  ...idsFromEnrol,
                  ...teacherIds,
                  ...adminIds,
                ])
                  .filter((id) => (seen.has(id) ? false : (seen.add(id), true)))
                  .filter((id) => id !== authorId);
                if (!audience.length) return;

                // Mentions: use IDs from the editor when available; fallback to API echo
                let mentionContactIds = Array.isArray(allMentions)
                  ? allMentions
                      .map((m) => String(((m?.unique_id) ?? (m?.id)) || "").trim())
                      .filter((s) => s.length > 0)
                  : [];
                if (!mentionContactIds.length && Array.isArray(result?.Submission_Mentions)) {
                  mentionContactIds = result.Submission_Mentions
                    .map((m) => String(((m?.unique_id) ?? (m?.id)) || "").trim())
                    .filter((s) => s.length > 0);
                }
                const mentionSet = new Set(mentionContactIds);

                // Resolve student enrolment id for canonical URLs when role is students
                async function resolveStudentEid(studentId, clsIdLocal) {
                  try {
                    const cache = (window.__awcEidCache ||= new Map());
                    const k = String(clsIdLocal);
                    let byClass = cache.get(k);
                    if (!byClass) {
                      byClass = new Map();
                      cache.set(k, byClass);
                    }
                    if (byClass.has(Number(studentId)))
                      return byClass.get(Number(studentId));
                    const q = `query getEnrolment($id: AwcContactID, $class_id: AwcClassID) { getEnrolment(query: [{ where: { student_id: $id } }, { andWhere: { class_id: $class_id } }]) { ID: id } }`;
                    const rs = await fetch(GRAPHQL_ENDPOINTssss, {
                      method: "POST",
                      headers: {
                        "Content-Type": "application/json",
                        "Api-Key": apiKeyKey,
                      },
                      body: JSON.stringify({
                        query: q,
                        variables: {
                          id: Number(studentId),
                          class_id: Number(clsIdLocal),
                        },
                      }),
                    }).then((r) => (r.ok ? r.json() : null));
                    const eid = Number(rs?.data?.getEnrolment?.ID || 0);
                    if (Number.isFinite(eid) && eid > 0) {
                      byClass.set(Number(studentId), eid);
                      return eid;
                    }
                  } catch (_) { }
                  return undefined;
                }

                // Build and send alerts
                function buildSubmissionAlertUrl(role, p) {
                  const BASE = "https://courses.writerscentre.com.au";
                  const r = String(role || "").toLowerCase();
                  const lessonUid = String(p.lessonUid || window.lessonUIDFromPage || window.lessonUid || "");
                  const base = `${BASE}/course-details/content/${encodeURIComponent(
                    lessonUid
                  )}`;
                  const qs = new URLSearchParams();
                  const idForSubmission = p.isComment
                    ? p.commentId || ""
                    : p.submissionId || p.commentId || "";
                  if (r === "students" || r === "student") {
                    if (p.eid != null) qs.set("eid", String(p.eid));
                  }
                  if (p.classId != null)
                    qs.set("classIdFromUrl", String(p.classId));
                  if (p.className) qs.set("className", String(p.className));
                  if (p.classUid) qs.set("classUid", String(p.classUid));
                  if (p.classId != null)
                    qs.set("currentClassID", String(p.classId));
                  if (p.className)
                    qs.set("currentClassName", String(p.className));
                  if (r === "students" || r === "student") {
                    if (p.classUid)
                      qs.set("currentClassUniqueID", String(p.classUid));
                  }
                  qs.set("submissionPostIs", String(idForSubmission || ""));
                  // Always include these keys per spec
                  qs.set("subUID", String(p.subUID));
                  qs.set("commentScrollId", String(p.commentScrollID));
                  if (p.notType) qs.set("notType", String(p.notType));
                  return `${base}?${qs.toString()}`;
                }
                const createAlertMutation = `mutation createAlert($payload: AlertCreateInput) { createAlert(payload: $payload) { id } }`;
                const actorName =
                  String(`[Visitor//Display Name]` || "").trim() || "Someone";
                for (const contactId of audience) {
                  // Determine mention by comparing the contact's unique_id against the mention set
                  let isMentioned = false;
                  const contactUid = idToUidMap.get(Number(contactId));
                  if (contactUid) {
                    isMentioned = mentionSet.has(String(contactUid));
                  } else {
                    // Fallback: in some cases mentions may have stored numeric ids
                    isMentioned = mentionSet.has(String(contactId));
                  }
                  const isTeacher = teacherIds.includes(Number(contactId));
                  const isAdmin = adminIds.includes(Number(contactId));
                  const role = isAdmin
                    ? "admin"
                    : isTeacher
                      ? "teacher"
                      : "students";
                  let eIdx;
                  if (role === "students")
                    eIdx = await resolveStudentEid(contactId, classId);
                  const params = {
                    classId: Number(classId),
                    classUid,
                    className,
                    courseUid,
                    eid: eIdx,
                    lessonUid:
                      window.lessonUIDFromPage || window.lessonUid || "",
                    assessmentType:
                      window.assessmentTypeFromPage ||
                      window.assessmentType ||
                      "",
                    submissionId: Number(submissionId),
                    subUID: String(uniqueId || ""),
                    commentScrollID: window.commentScrollIDFromPage || "",
                    notType: "Submissions",
                  };
                  const readyParams = (window.AWC && typeof window.AWC.waitForAlertParams === 'function')
                    ? await window.AWC.waitForAlertParams('submission', params)
                    : params;
                  try {
                    console.log("[SubmissionAlerts] Recipient params", {
                      contactId,
                      role,
                      eid: eIdx,
                      params,
                      url:
                        window.AWC &&
                        typeof window.AWC.buildAlertUrl === "function"
                          ? window.AWC.buildAlertUrl(role, "submission", readyParams)
                          : "(AWC missing)",
                  });
                  } catch (_) {}
                  const originCanonical =
                    window.AWC && typeof window.AWC.buildAlertUrl === "function"
                      ? window.AWC.buildAlertUrl(role, "submission", readyParams)
                      : buildSubmissionAlertUrl(role, readyParams);
                  const teacherCanonical =
                    window.AWC && typeof window.AWC.buildAlertUrl === "function"
                      ? window.AWC.buildAlertUrl(
                          "teacher",
                          "submission",
                          readyParams
                        )
                      : buildSubmissionAlertUrl("teacher", readyParams);
                  const adminCanonical =
                    window.AWC && typeof window.AWC.buildAlertUrl === "function"
                      ? window.AWC.buildAlertUrl("admin", "submission", readyParams)
                      : buildSubmissionAlertUrl("admin", readyParams);
                  const title = isMentioned
                    ? "You have been mentioned in a submission"
                    : "A submission has been posted";
                  const payloadAlert = {
                    alert_type: isMentioned
                      ? "Submission Mention"
                      : "Submission",
                    title,
                    content: contentText,
                    created_at: createdAt,
                    is_mentioned: !!isMentioned,
                    is_read: false,
                    alert_status: 'Published',
                    notified_contact_id: Number(contactId),
                    origin_url: originCanonical,
                    origin_url_teacher: teacherCanonical,
                    origin_url_admin: adminCanonical,
                    parent_class_id: Number(classId),
                    parent_submission_id: Number(submissionId),
                  };
                  try {
                    await fetch(GRAPHQL_ENDPOINTssss, {
                      method: "POST",
                      headers: {
                        "Content-Type": "application/json",
                        "Api-Key": apiKeyKey,
                      },
                      body: JSON.stringify({
                        query: createAlertMutation,
                        variables: { payload: payloadAlert },
                      }),
                    });
                  } catch (_) { }
                }

                if (mentionContactIds.length) {
                  const updateMutation = `mutation updateContact($id: AwcContactID!, $payload: ContactUpdateInput!) { updateContact(query: [{ where: { id: $id } }], payload: $payload) { has__new__notification } }`;
                  for (const mid of mentionContactIds) {
                    try {
                      await fetch(GRAPHQL_ENDPOINTssss, {
                        method: "POST",
                        headers: {
                          "Content-Type": "application/json",
                          "Api-Key": apiKeyKey,
                        },
                        body: JSON.stringify({
                          query: updateMutation,
                          variables: {
                            id: Number(mid),
                            payload: { has__new__notification: true },
                          },
                        }),
                      });
                    } catch (_) { }
                  }
                }
              } catch (e) {
                console.error(
                  "Submission alert creation error (file submission)",
                  e
                );
              }
            })();
          } catch (_) { }
          textarea.classList.remove("opacity-50", "pointer-events-none");
          uploadButton.classList.remove("opacity-50", "pointer-events-none");
          document.querySelector(".dltFileWrap").click();
          document.querySelector("#noteForSubmission").innerHTML = "";
          document
            .querySelector("#noteForSubmission")
            .classList.remove("hidden");
          renderSubmissions();
        } else {
          textarea.classList.remove("opacity-50", "pointer-events-none");
          uploadButton.classList.remove("opacity-50", "pointer-events-none");

          document.querySelector("#error-fileName").textContent = file.name;
          document
            .querySelector("#upload_failed_msg")
            .classList.remove("hidden");
          document.querySelector("#upload_failed_msg").classList.add("flex");
          document.querySelector(".dltFileWrap").click();
          document.querySelector("#noteForSubmission").innerHTML = "";
        }
      } catch (error) {
        textarea.classList.remove("opacity-50", "pointer-events-none");
        uploadButton.classList.remove("opacity-50", "pointer-events-none");

        clearInterval(interval);
        updateProgress(100);
        document.querySelector("#upload_failed_msg").textContent = file.name;
        document.querySelector("#upload_failed_msg").classList.remove("hidden");
        document.querySelector("#upload_failed_msg").classList.add("flex");
        document.querySelector(".dltFileWrap").click();
        document.querySelector("#noteForSubmission").innerHTML = "";
      } finally {
        setTimeout(() => (progressBarContainer.style.display = "none"), 1000);
      }
    });
  });

  function updateProgress(progress) {
    const progressBar = document.querySelector("#uploadProgress");
    if (progressBar) {
      progressBar.style.width = `${progress}%`;
    }
  }
</script>

<script>
  function decodeAwsParam(awsParam) {
    if (!awsParam) {
      awsParam = window.awsParam;
    }
    const serializedString = atob(awsParam);
    const hashMatch = serializedString.match(/s:\d+:"([a-f0-9]+)"/);
    const expiryMatch = serializedString.match(/i:(\d+)/);

    return {
      hash: hashMatch ? hashMatch[1] : null,
      expiry: expiryMatch ? parseInt(expiryMatch[1], 10) : null,
    };
  }
  function encodeAwsParam(hash, currentEpoch) {
    if (typeof currentEpoch !== "number") {
      currentEpoch = Math.round(Date.now() / 1000);
    }
    const expiry = new Date(currentEpoch * 1000);
    expiry.setTime(expiry.getTime() + 12 * 60 * 60 * 1000);
    return btoa(
      `a:2:{s:4:"hash";s:${hash.length}:"${hash}";s:6:"expiry";i:${Math.round(
        expiry.getTime() / 1000
      )};}`
    );
  }
  function createS3FileId(key, filename) {
    return `${key.replace("_${filename}", "")}_${filename}`;
  }
  function getS3UploadParams(awsParam, url) {
    if (typeof awsParam !== "string") {
      awsParam = window.awsParam;
    }
    if (typeof url !== "string") {
      url = `//${window.location.host}/s/aws`;
    }
    const formData = new FormData();
    formData.append("awsParam", JSON.stringify(awsParam));
    return fetch(url, {
      method: "POST",
      body: formData,
    })
      .then((res) => res.json())
      .then((object) => {
        if (object.code === 0 && object.data) {
          console.log("object data is", object.data);
          return object.data;
        }
        return null;
      });
  }
  function uploadFiles(filesToUpload, s3Params, toSubmit) {
    console.log(s3Params, "s3Params");
    const paramsInputs = s3Params.inputs;
    const method = s3Params.attributes.method;
    const action = s3Params.attributes.action;
    const uploadPromises = filesToUpload.map(({ file, fieldName }) => {
      return new Promise((resolve) => {
        let s3FormData = new FormData();
        // Append all required S3 fields
        for (const key in paramsInputs) {
          s3FormData.append(key, paramsInputs[key]);
        }
        // Append the actual file
        s3FormData.append("Content-Type", file.type);
        s3FormData.append("file", file, file.name);
        let xhr = new XMLHttpRequest();
        xhr.open(method, action);
        xhr.onloadend = function () {
          if (xhr.status === 204) {
            let s3Id = createS3FileId(paramsInputs.key, file.name);
            const result = {
              name: file.name,
              type: file.type,
              s3_id: s3Id,
            };
            if (toSubmit && fieldName) {
              toSubmit[fieldName] = JSON.stringify(result);
            }
            resolve(result);
          } else {
            console.error("File upload failed", xhr.statusText);
            resolve(null);
          }
        };

        xhr.send(s3FormData);
      });
    });

    return Promise.all(uploadPromises);
  }
  function processFileFields(
    toSubmit,
    filesToUpload,
    awsParamHash,
    awsParamUrl
  ) {
    let awsParam;
    if (!awsParamHash) {
      awsParam = window.awsParam;
    } else if (typeof awsParamHash === "string") {
      awsParam = encodeAwsParam(awsParamHash);
    }

    return getS3UploadParams(awsParam, awsParamUrl).then((s3Params) => {
      if (!s3Params) {
        const e = new Error("Failed to retrieve s3Params.");
        e.failures = filesToUpload;
        throw e;
      }
      return uploadFiles(filesToUpload, s3Params, toSubmit).then((result) => {
        let error;
        for (let i = 0; i < result.length; i++) {
          if (!result[i]) {
            if (!error) {
              error = new Error("One or more files failed to upload.");
              error.failures = [];
            }
            error.failures.push(filesToUpload[i]);
          }
        }
        if (error) {
          throw error;
        }
        return toSubmit;
      });
    });
  }
</script>
